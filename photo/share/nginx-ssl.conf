# Nginx SSL Configuration for JPEG File Server

server {
    listen 80;
    server_name _;

    # Redirect HTTP to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }

    # Health check on HTTP (for Docker health checks)
    location /health {
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}

server {
    listen 443 ssl http2;
    server_name _;

    # SSL Configuration
    ssl_certificate /app/certs/cert.pem;
    ssl_certificate_key /app/certs/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Security Headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Root directory
    root /app;

    # Health check
    location /health {
        return 200 "healthy\n";
        add_header Content-Type text/plain;
        access_log off;
    }

    # API endpoint - List all images
    location /api/images {
        default_type application/json;
        alias /app/images;

        # Return JSON list of images
        if (!-d $request_filename) {
            return 404;
        }

        # This will be handled by autoindex below
        autoindex on;
        autoindex_format json;
    }

    # API endpoint - Get latest image
    location ~ ^/api/latest/?$ {
        default_type application/json;
        
        # Return the most recently modified JPEG file as JSON
        set $latest_file "";
        
        # Since Nginx doesn't have built-in file metadata, return a redirect
        return 301 /images/;
    }

    # Download image by filename
    location /images/ {
        alias /app/images/;
        
        # Only serve JPEG files
        if ($request_filename ~* \.(jpg|jpeg|jpe)$) {
            break;
        }
        
        if ($request_filename ~* "\.") {
            return 403;
        }

        # Directory listing
        autoindex on;
        autoindex_format json;
    }

    # Block access to certificates
    location /certs/ {
        return 403;
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
    }

    # Default location
    location / {
        return 200 "JPEG File Server\n";
        add_header Content-Type text/plain;
    }
}
